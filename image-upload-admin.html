<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Upload Images to Supabase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .auth-section {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .item-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        .item-header {
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 10px;
        }
        .item-name {
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
        }
        .upload-section {
            margin-top: 15px;
        }
        .file-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .upload-btn {
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
        .upload-btn:hover {
            background: #45a049;
        }
        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        .btn {
            background: #2196F3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        .btn:hover {
            background: #1976D2;
        }
        .auth-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñºÔ∏è Admin - Upload Images to Supabase</h1>
            <p>Upload h√¨nh ·∫£nh cho DichVu v√† KhuyenMai</p>
        </div>

        <div class="auth-section">
            <h3>üîê Authentication</h3>
            <input type="text" id="username" class="auth-input" placeholder="Username (admin)" value="admin">
            <input type="password" id="password" class="auth-input" placeholder="Password">
            <button onclick="login()" class="btn">Login</button>
            <div id="auth-status"></div>
        </div>

        <div class="controls">
            <button onclick="loadItemsWithoutImages()" class="btn">üîÑ Load Items Without Images</button>
            <button onclick="runCleanup()" class="btn">üßπ Cleanup Missing Images</button>
        </div>

        <div id="items-container">
            <p>Click "Load Items Without Images" to start...</p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5009/api';
        let authToken = '';

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const authStatus = document.getElementById('auth-status');

            try {
                authStatus.innerHTML = '<div class="status loading">Logging in...</div>';
                
                const response = await fetch(`${API_BASE}/Auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.token) {
                    authToken = data.token;
                    authStatus.innerHTML = '<div class="status success">‚úÖ Logged in successfully!</div>';
                    loadItemsWithoutImages();
                } else {
                    authStatus.innerHTML = `<div class="status error">‚ùå Login failed: ${data.message || 'Unknown error'}</div>`;
                }
            } catch (error) {
                authStatus.innerHTML = `<div class="status error">‚ùå Login error: ${error.message}</div>`;
            }
        }

        async function loadItemsWithoutImages() {
            if (!authToken) {
                alert('Please login first!');
                return;
            }

            const container = document.getElementById('items-container');
            container.innerHTML = '<p>Loading items...</p>';

            try {
                const response = await fetch(`${API_BASE}/Migration/items-without-images`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    displayItems(data.items);
                } else {
                    container.innerHTML = `<div class="status error">‚ùå Failed to load items: ${data.message}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }

        function displayItems(items) {
            const container = document.getElementById('items-container');
            
            if (items.length === 0) {
                container.innerHTML = '<div class="status success">üéâ All items have images!</div>';
                return;
            }

            const itemsHtml = items.map(item => `
                <div class="item-card">
                    <div class="item-header">${item.type} - ${item.id}</div>
                    <div class="item-name"><strong>${item.name}</strong></div>
                    <div class="item-name">${item.description || 'No description'}</div>
                    <div class="upload-section">
                        <input type="file" 
                               class="file-input" 
                               id="file-${item.id}" 
                               accept="image/*">
                        <button class="upload-btn" 
                                onclick="uploadImage('${item.type}', '${item.id}')">
                            üì§ Upload Image
                        </button>
                        <div id="status-${item.id}"></div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <h3>üìã Items without images (${items.length})</h3>
                <div class="items-grid">${itemsHtml}</div>
            `;
        }

        async function uploadImage(type, id) {
            if (!authToken) {
                alert('Please login first!');
                return;
            }

            const fileInput = document.getElementById(`file-${id}`);
            const statusDiv = document.getElementById(`status-${id}`);
            const uploadBtn = fileInput.nextElementSibling;

            if (!fileInput.files[0]) {
                statusDiv.innerHTML = '<div class="status error">‚ùå Please select a file</div>';
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            const endpoint = type === 'DichVu' 
                ? `Migration/upload-dichvu-image/${id}`
                : `Migration/upload-khuyenmai-image/${id}`;

            try {
                uploadBtn.disabled = true;
                uploadBtn.textContent = '‚è≥ Uploading...';
                statusDiv.innerHTML = '<div class="status loading">‚è≥ Uploading to Supabase...</div>';

                const response = await fetch(`${API_BASE}/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    statusDiv.innerHTML = `<div class="status success">‚úÖ Uploaded successfully!<br>URL: ${data.imageUrl}</div>`;
                    uploadBtn.textContent = '‚úÖ Uploaded';
                    uploadBtn.style.background = '#4CAF50';
                    
                    // Remove this item from the list after 2 seconds
                    setTimeout(() => {
                        loadItemsWithoutImages();
                    }, 2000);
                } else {
                    statusDiv.innerHTML = `<div class="status error">‚ùå Upload failed: ${data.message}</div>`;
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'üì§ Upload Image';
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üì§ Upload Image';
            }
        }

        async function runCleanup() {
            if (!authToken) {
                alert('Please login first!');
                return;
            }

            if (!confirm('Are you sure you want to cleanup missing images? This will set NULL for all missing image paths.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/Migration/cleanup-missing-images`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    alert(`Cleanup completed!\nTotal: ${data.totalItems}\nSuccess: ${data.successCount}\nFailed: ${data.failureCount}`);
                    loadItemsWithoutImages();
                } else {
                    alert(`Cleanup failed: ${data.message}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Auto-login if credentials are provided
        window.onload = function() {
            console.log('üñºÔ∏è Image Upload Admin Tool loaded');
            console.log('üìù Instructions:');
            console.log('1. Login with admin credentials');
            console.log('2. Click "Load Items Without Images"');
            console.log('3. Upload images for each item');
            console.log('4. Images will be saved to Supabase Storage');
        };
    </script>
</body>
</html>