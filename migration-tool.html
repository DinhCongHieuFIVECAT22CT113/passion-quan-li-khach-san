<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migration Tool - Supabase Storage</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .login-section, .migration-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .login-section {
            background-color: #f8f9fa;
        }
        .migration-section {
            background-color: #e8f5e8;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .danger {
            background-color: #dc3545;
        }
        .danger:hover {
            background-color: #c82333;
        }
        .success {
            background-color: #28a745;
        }
        .success:hover {
            background-color: #218838;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Migration Tool - Supabase Storage</h1>
        
        <!-- Login Section -->
        <div class="login-section">
            <h3>üîê ƒêƒÉng nh·∫≠p Admin</h3>
            <div>
                <input type="text" id="username" placeholder="Username (admin)" value="admin">
                <input type="password" id="password" placeholder="Password (admin123)" value="admin123">
                <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
            </div>
            <div id="loginStatus" class="status" style="display: none;"></div>
            
            <!-- Manual Token Input -->
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                <h4>üîë Ho·∫∑c nh·∫≠p Token th·ªß c√¥ng:</h4>
                <div>
                    <input type="text" id="manualToken" placeholder="Paste JWT token here..." style="width: 70%;">
                    <button onclick="setManualToken()">S·ª≠ d·ª•ng Token</button>
                </div>
                <small style="color: #666;">
                    üí° N·∫øu ƒëƒÉng nh·∫≠p t·ª± ƒë·ªông b·ªã l·ªói CORS, b·∫°n c√≥ th·ªÉ l·∫•y token t·ª´ Postman/Browser DevTools v√† paste v√†o ƒë√¢y
                </small>
            </div>
        </div>

        <!-- Migration Section -->
        <div class="migration-section">
            <h3>üì¶ Migration Images</h3>
            <p><strong>L∆∞u √Ω:</strong> Ch·ªâ Admin (Role R00) m·ªõi c√≥ th·ªÉ ch·∫°y migration!</p>
            
            <div>
                <button onclick="migrateAllImages()" id="migrateAllBtn" disabled>
                    üîÑ Migrate T·∫•t c·∫£ Images
                </button>
                <button onclick="migrateDichVuImages()" id="migrateDichVuBtn" disabled>
                    üè® Migrate DichVu Images
                </button>
                <button onclick="migrateKhuyenMaiImages()" id="migrateKhuyenMaiBtn" disabled>
                    üéÅ Migrate KhuyenMai Images
                </button>
            </div>
            
            <div id="migrationResult" class="result" style="display: none;"></div>
        </div>

        <!-- Instructions -->
        <div style="background-color: #fff3cd; padding: 15px; border-radius: 5px; margin-top: 20px;">
            <h4>üìã H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:</h4>
            <ol>
                <li>ƒê·∫£m b·∫£o Backend ƒëang ch·∫°y tr√™n <code>http://localhost:5009</code></li>
                <li>ƒê·∫£m b·∫£o ƒë√£ setup Supabase Storage bucket <code>hotel-images</code></li>
                <li>ƒêƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n Admin HO·∫∂C nh·∫≠p token th·ªß c√¥ng</li>
                <li>Ch·ªçn lo·∫°i migration mu·ªën ch·∫°y</li>
                <li>Ki·ªÉm tra k·∫øt qu·∫£ trong ph·∫ßn Result</li>
            </ol>
            
            <h4>üîß Kh·∫Øc ph·ª•c l·ªói CORS:</h4>
            <p>N·∫øu g·∫∑p l·ªói "Failed to fetch", h√£y l√†m theo c√°c b∆∞·ªõc sau:</p>
            <ol>
                <li><strong>S·ª≠ d·ª•ng Postman:</strong>
                    <ul>
                        <li>POST <code>http://localhost:5009/api/Auth/login</code></li>
                        <li>Body: <code>{"username":"admin","password":"admin123"}</code></li>
                        <li>Copy token t·ª´ response</li>
                    </ul>
                </li>
                <li><strong>S·ª≠ d·ª•ng Browser DevTools:</strong>
                    <ul>
                        <li>M·ªü F12 ‚Üí Console</li>
                        <li>Ch·∫°y: <code>fetch('http://localhost:5009/api/Auth/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:'admin',password:'admin123'})}).then(r=>r.json()).then(console.log)</code></li>
                        <li>Copy token t·ª´ console</li>
                    </ul>
                </li>
                <li>Paste token v√†o √¥ "Token th·ªß c√¥ng" v√† click "S·ª≠ d·ª•ng Token"</li>
            </ol>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5009/api';
        let authToken = null;

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginStatus = document.getElementById('loginStatus');

            try {
                loginStatus.style.display = 'block';
                loginStatus.className = 'status info';
                loginStatus.textContent = 'ƒêang ƒëƒÉng nh·∫≠p...';

                const response = await fetch(`${API_BASE_URL}/Auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    
                    loginStatus.className = 'status success';
                    loginStatus.textContent = `‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng! Role: ${data.role}`;
                    
                    // Show token for manual copy
                    loginStatus.textContent += `\n\nüîë Token (copy ƒë·ªÉ s·ª≠ d·ª•ng th·ªß c√¥ng n·∫øu c·∫ßn):\n${authToken}`;
                    
                    enableMigrationButtons();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i');
                }
            } catch (error) {
                loginStatus.className = 'status error';
                loginStatus.textContent = `‚ùå L·ªói: ${error.message}`;
                
                // Show CORS workaround instructions
                if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    loginStatus.textContent += `\n\nüí° L·ªói CORS - H∆∞·ªõng d·∫´n kh·∫Øc ph·ª•c:\n`;
                    loginStatus.textContent += `1. M·ªü Postman ho·∫∑c Browser DevTools\n`;
                    loginStatus.textContent += `2. G·ªçi API: POST ${API_BASE_URL}/Auth/login\n`;
                    loginStatus.textContent += `3. Body: {"username":"${username}","password":"${password}"}\n`;
                    loginStatus.textContent += `4. Copy token t·ª´ response v√† paste v√†o √¥ "Token th·ªß c√¥ng" ·ªü tr√™n`;
                }
                
                authToken = null;
                disableMigrationButtons();
            }
        }

        function setManualToken() {
            const token = document.getElementById('manualToken').value.trim();
            const loginStatus = document.getElementById('loginStatus');
            
            if (!token) {
                alert('Vui l√≤ng nh·∫≠p token!');
                return;
            }
            
            authToken = token;
            loginStatus.style.display = 'block';
            loginStatus.className = 'status success';
            loginStatus.textContent = '‚úÖ ƒê√£ set token th·ªß c√¥ng! C√≥ th·ªÉ ch·∫°y migration.';
            
            enableMigrationButtons();
        }

        function enableMigrationButtons() {
            document.getElementById('migrateAllBtn').disabled = false;
            document.getElementById('migrateDichVuBtn').disabled = false;
            document.getElementById('migrateKhuyenMaiBtn').disabled = false;
        }

        function disableMigrationButtons() {
            document.getElementById('migrateAllBtn').disabled = true;
            document.getElementById('migrateDichVuBtn').disabled = true;
            document.getElementById('migrateKhuyenMaiBtn').disabled = true;
        }

        async function callMigrationAPI(endpoint, buttonId) {
            if (!authToken) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!');
                return;
            }

            const button = document.getElementById(buttonId);
            const resultDiv = document.getElementById('migrationResult');
            
            try {
                button.disabled = true;
                button.textContent = '‚è≥ ƒêang x·ª≠ l√Ω...';
                
                resultDiv.style.display = 'block';
                resultDiv.className = 'result';
                resultDiv.textContent = 'ƒêang ch·∫°y migration...\n';

                const response = await fetch(`${API_BASE_URL}/Migration/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ ${data.message}\n\n` +
                        `üìä Th·ªëng k√™:\n` +
                        `- T·ªïng s·ªë items: ${data.totalItems}\n` +
                        `- Th√†nh c√¥ng: ${data.successCount}\n` +
                        `- Th·∫•t b·∫°i: ${data.failureCount}\n\n`;
                    
                    if (data.successMessages && data.successMessages.length > 0) {
                        resultDiv.textContent += `‚úÖ Th√†nh c√¥ng:\n${data.successMessages.join('\n')}\n\n`;
                    }
                    
                    if (data.errors && data.errors.length > 0) {
                        resultDiv.textContent += `‚ùå L·ªói:\n${data.errors.join('\n')}`;
                    }
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå L·ªói: ${data.message || data.error}`;
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`;
            } finally {
                button.disabled = false;
                // Reset button text
                if (buttonId === 'migrateAllBtn') button.textContent = 'üîÑ Migrate T·∫•t c·∫£ Images';
                else if (buttonId === 'migrateDichVuBtn') button.textContent = 'üè® Migrate DichVu Images';
                else if (buttonId === 'migrateKhuyenMaiBtn') button.textContent = 'üéÅ Migrate KhuyenMai Images';
            }
        }

        function migrateAllImages() {
            callMigrationAPI('migrate-all-images', 'migrateAllBtn');
        }

        function migrateDichVuImages() {
            callMigrationAPI('migrate-dichvu-images', 'migrateDichVuBtn');
        }

        function migrateKhuyenMaiImages() {
            callMigrationAPI('migrate-khuyenmai-images', 'migrateKhuyenMaiBtn');
        }
    </script>
</body>
</html>